
var elastictest = require('elastictest'),
    indexer = require('../../index');

module.exports.tests = {};

var worldPolygon = {
  'type': 'LineString',
  'coordinates': [
    [
      -17.2265625,
      14.859850400601037
    ],
    [
      -16.083984375,
      17.811456088564483
    ],
    [
      -16.787109375,
      20.879342971957897
    ],
    [
      -16.611328125,
      23.56398712845123
    ],
    [
      -13.798828125,
      26.667095801104814
    ],
    [
      -9.755859375,
      29.6880527498568
    ],
    [
      -9.31640625,
      32.32427558887655
    ],
    [
      -7.822265625000001,
      33.797408767572485
    ],
    [
      -5.625,
      35.96022296929667
    ],
    [
      -4.658203125,
      35.10193405724606
    ],
    [
      -1.7578125,
      35.53222622770337
    ],
    [
      3.515625,
      37.020098201368114
    ],
    [
      8.701171874999998,
      37.09023980307208
    ],
    [
      12.3046875,
      36.949891786813296
    ],
    [
      10.72265625,
      36.4566360115962
    ],
    [
      11.337890625,
      35.38904996691167
    ],
    [
      10.37109375,
      34.08906131584996
    ],
    [
      12.392578125,
      32.84267363195431
    ],
    [
      15.205078125,
      32.76880048488168
    ],
    [
      15.644531250000002,
      31.50362930577303
    ],
    [
      18.28125,
      30.90222470517144
    ],
    [
      19.423828125,
      30.29701788337205
    ],
    [
      20.126953125,
      31.57853542647338
    ],
    [
      20.302734375,
      32.54681317351514
    ],
    [
      21.796875,
      33.063924198120645
    ],
    [
      24.345703125,
      31.952162238024975
    ],
    [
      28.828124999999996,
      31.203404950917395
    ],
    [
      31.728515624999996,
      31.203404950917395
    ],
    [
      33.3984375,
      27.994401411046173
    ],
    [
      35.419921875,
      23.079731762449878
    ],
    [
      37.177734375,
      20.879342971957897
    ],
    [
      37.529296875,
      18.646245142670608
    ],
    [
      39.111328125,
      16.97274101999902
    ],
    [
      40.42968749999999,
      15.029685756555674
    ],
    [
      41.572265625,
      13.581920900545844
    ],
    [
      42.626953125,
      12.382928338487408
    ],
    [
      43.9453125,
      10.660607953624762
    ],
    [
      46.142578125,
      10.31491928581316
    ],
    [
      47.724609375,
      11.178401873711785
    ],
    [
      49.39453125,
      11.350796722383684
    ],
    [
      51.240234375,
      11.953349393643416
    ],
    [
      51.064453125,
      9.882275493429953
    ],
    [
      49.482421875,
      6.751896464843375
    ],
    [
      48.1640625,
      3.601142320158722
    ],
    [
      46.142578125,
      2.811371193331128
    ],
    [
      42.978515625,
      0.26367094433665017
    ],
    [
      41.39648437499999,
      -2.0210651187669897
    ],
    [
      39.90234375,
      -4.302591077119676
    ],
    [
      38.583984375,
      -6.577303118123875
    ],
    [
      39.814453125,
      -9.535748998133627
    ],
    [
      40.517578125,
      -11.350796722383672
    ],
    [
      40.60546875,
      -15.199386048559994
    ],
    [
      39.990234375,
      -16.55196172197251
    ],
    [
      37.529296875,
      -17.5602465032949
    ],
    [
      34.80468749999999,
      -19.642587534013032
    ],
    [
      34.98046875,
      -21.943045533438166
    ],
    [
      34.892578125,
      -24.287026865376422
    ],
    [
      33.046875,
      -26.194876675795218
    ],
    [
      31.904296874999996,
      -28.84467368077178
    ],
    [
      29.70703125,
      -31.05293398570514
    ],
    [
      27.509765625,
      -33.13755119234615
    ],
    [
      24.697265625,
      -33.9433599465788
    ],
    [
      22.587890625,
      -33.9433599465788
    ],
    [
      19.335937499999996,
      -34.74161249883172
    ],
    [
      17.578125,
      -32.69486597787506
    ],
    [
      18.10546875,
      -31.653381399663985
    ],
    [
      16.611328125,
      -28.84467368077178
    ],
    [
      15.1171875,
      -27.059125784374054
    ],
    [
      14.414062499999998,
      -23.805449612314625
    ],
    [
      13.974609375,
      -21.53484700204879
    ],
    [
      12.041015625,
      -18.562947442888312
    ],
    [
      12.041015625,
      -16.04581345375217
    ],
    [
      12.12890625,
      -13.496472765758952
    ],
    [
      13.7109375,
      -11.781325296112277
    ],
    [
      13.18359375,
      -8.841651120809145
    ],
    [
      12.65625,
      -6.489983332670651
    ],
    [
      11.865234375,
      -4.390228926463384
    ],
    [
      9.580078125,
      -2.5479878714713835
    ],
    [
      8.7890625,
      -0.3515602939922709
    ],
    [
      9.140625,
      1.3182430568620136
    ],
    [
      9.667968749999998,
      3.6888551431470478
    ],
    [
      7.822265625000001,
      4.653079918274051
    ],
    [
      6.064453125,
      4.302591077119676
    ],
    [
      3.779296875,
      6.315298538330033
    ],
    [
      1.58203125,
      6.227933930268672
    ],
    [
      -0.3515625,
      5.441022303717974
    ],
    [
      -2.28515625,
      5.090944175033399
    ],
    [
      -5.361328125,
      5.178482088522876
    ],
    [
      -6.591796875,
      4.653079918274051
    ],
    [
      -7.646484374999999,
      4.390228926463384
    ],
    [
      -10.72265625,
      6.053161295714079
    ],
    [
      -12.12890625,
      8.059229627200192
    ],
    [
      -13.359375,
      8.059229627200192
    ],
    [
      -13.623046875,
      9.795677582829743
    ],
    [
      -14.23828125,
      10.746969318460001
    ],
    [
      -16.787109375,
      12.12526421833159
    ],
    [
      -16.611328125,
      13.752724664397
    ],
    [
      -17.05078125,
      14.43468021529728
    ]
  ]
};

module.exports.tests.load_test = function(test, common) {

  test('load test', function(t) {

    var suite = new elastictest.Suite();

    suite.action( function( done ){
      suite.client.indices.putMapping({
        index: suite.props.index,
        type: 'type1',
        body: {
          properties: {
            shape: {
              type: 'geo_shape',
              tree: 'quadtree',
              tree_levels: '30'
            }
          }
        }
      }, done );
    });

    suite.action( function( done ){
      suite.client.indices.getSettings({
        index: suite.props.index
      }, function( err, settings ){
        var shards = parseInt( settings[ suite.props.index ].settings.index.number_of_shards, 10 );
        suite.client.cluster.putSettings({
          body: {
            'transient' : {
              'threadpool.bulk.queue_size' : shards
            }
          }
        }, done );
      });
    });

    suite.action( function( done ){

      var manager = new indexer.TransactionManager(
        suite.client,
        {
          batch: { size: 1000 },
          concurrency: { min: 1, max: 5 }
        },
        done
      );

      var stream = manager.operationWriteStream();

      for( var x=1; x<10009; x++ ){        
        stream.write( new indexer.Operation({ index : {
          _index : suite.props.index,
          _type : 'type1',
          _id : x
        }}, {
          id: x,
          shape: worldPolygon
        } ));
      }

      stream.end();

    });

    // correct count
    suite.assert( function( done ){
      suite.client.count({
        index: suite.props.index,
        type: 'type1'
      }, function( err, res ){
        t.equal( res.count, 10008, 'record count' );
        done();
      });
    });

    suite.run( t.end );

  });
};

module.exports.all = function (tape, common) {

  function test(name, testFunction) {
    return tape('transaction_manager: ' + name, testFunction);
  }

  for( var testCase in module.exports.tests ){
    module.exports.tests[testCase](test, common);
  }
};